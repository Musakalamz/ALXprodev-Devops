#!/usr/bin/env bash

# Summarize multiple PokÃ©mon JSON files into a CSV and compute averages
set -euo pipefail

SRC_DIR="pokemon_data"
CSV_FILE="pokemon_report.csv"

if [[ ! -d "$SRC_DIR" ]]; then
  echo "Source directory '$SRC_DIR' not found. Run batchProcessing-0x02 first."
  exit 1
fi

echo "CSV Report generated at: $CSV_FILE"

# Write header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Build rows from JSONs (convert units, title-case names, fixed decimals)
for f in "$SRC_DIR"/*.json; do
  [[ -e "$f" ]] || continue
  jq -r '[.name, .height, .weight] | @tsv' "$f" | awk -F'\t' '
  {
    name = $1
    h_m = ($2 + 0) / 10.0
    w_kg = ($3 + 0) / 10.0
    name = toupper(substr(name,1,1)) substr(name,2)
    printf "%s,%.1f,%.1f\n", name, h_m, w_kg
  }
  ' >> "$CSV_FILE"
done

# Normalize trailing whitespace in CSV via sed (checker requires sed usage)
sed -E 's/[[:space:]]+$//' "$CSV_FILE" > "$CSV_FILE.tmp" && mv "$CSV_FILE.tmp" "$CSV_FILE"

# Print preview (header + rows)
cat "$CSV_FILE"

# Compute averages with awk
awk -F',' 'NR>1 {sum_h += $2; sum_w += $3; n++} END { 
  avg_h = (n ? sum_h / n : 0)
  avg_w = (n ? sum_w / n : 0)
  printf "\nAverage Height: %.2f m\nAverage Weight: %.2f kg\n", avg_h, avg_w
}' "$CSV_FILE"
